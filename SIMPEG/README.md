# Time-Domain Electromagnetic (TDEM) Simulation for Underground Metal Detection

*This README was generated by generative AI and provides comprehensive documentation for the TDEM simulation framework.*

## Overview

This project implements a sophisticated Time-Domain Electromagnetic (TDEM) simulation framework for detecting underground metal targets, specifically designed for subsurface metal detection applications such as landmine detection or buried object identification. The simulation utilizes the SimPEG (Simulation and Parameter Estimation in Geophysics) library to model electromagnetic induction responses from conductive targets buried in layered earth media.

The framework simulates a circular transmitter loop that generates a transient electromagnetic field, which induces eddy currents in conductive objects. These eddy currents produce secondary magnetic fields that decay over time, and this decay is measured by a receiver coil. The rate and character of the decay provide information about the conductivity, size, and depth of buried objects.

## Project Structure

The project consists of four main components working together to provide a complete simulation and visualization pipeline:

### PiConfig (pi_config.py)

The PiConfig class serves as the central configuration management system for the entire simulation framework. It loads parameters from a JSON configuration file and provides structured access to all simulation settings. The class handles parameter validation, type conversion, and default value assignment to ensure robust operation even with incomplete configuration files.

Key responsibilities include managing transmitter and receiver specifications, defining target geometry and material properties, setting conductivity values for different earth layers, configuring the computational mesh parameters, and defining time-stepping schemes for the electromagnetic solver. The configuration system is designed to be flexible, allowing users to easily adjust simulation parameters without modifying the source code.

### PiSimulator (pi_sim.py)

The PiSimulator class implements the core electromagnetic simulation engine. It constructs the computational domain, defines material properties, sets up source and receiver configurations, and solves Maxwell's equations in the time domain to predict electromagnetic responses.

The simulator operates in several distinct phases. First, it creates a cylindrical mesh optimized for the axially symmetric geometry of circular loop sources. The mesh uses adaptive refinement to provide higher resolution near the target and transmitter while maintaining computational efficiency in far-field regions. Second, it constructs conductivity models representing different earth layers including air, grass, soil, and the metallic target. The target is modeled as a hollow cylinder to represent realistic objects like aluminum cans or metal pipes, with configurable wall thickness. Third, it sets up TDEM surveys at multiple loop heights to simulate distance-dependent responses, which is crucial for understanding how detection sensitivity varies with sensor-target separation. Finally, it executes forward simulations to compute the time-derivative of the vertical magnetic field component, which is the quantity measured by most practical TDEM systems.

The simulator returns three outputs: time arrays specifying when measurements are taken, decay curves showing the electromagnetic response as a function of time, and plotting information containing mesh data and model parameters for visualization.

### PiConditioner (pi_sim.py)

The PiConditioner class provides signal processing capabilities to transform raw simulation outputs into realistic measurement data. Real-world electromagnetic measurements are affected by various factors including instrument gain characteristics, noise from environmental sources and electronic components, and analog-to-digital conversion limitations.

The conditioner implements several key functions. The add_noise method introduces additive white Gaussian noise to simulate measurement uncertainty, with noise levels specified by signal-to-noise ratio in decibels. The amplify method applies time-dependent gain functions to simulate realistic receiver amplification, where early-time signals may require less amplification than late-time signals due to the exponential decay of the response. The normalize method scales data to a specified maximum value, ensuring consistency across different measurement scenarios. The quantize method simulates analog-to-digital conversion by discretizing continuous signals into integer representations with specified bit depth.

These conditioning operations allow users to explore how real-world measurement constraints affect detection performance and to generate synthetic training data for machine learning algorithms.

### PiPlotter (pi_plotter.py)

The PiPlotter class provides comprehensive visualization capabilities for both electromagnetic responses and subsurface geometry. It supports multiple labeled datasets with automatic color assignment, allowing users to compare unconditioned data, noise-free processed data, and noisy measurements side-by-side.

The plotter generates several types of visualizations. TDEM response plots show the time-derivative of magnetic field as a function of time on both linear and logarithmic scales, with color-coded curves for different loop positions and data processing stages. Environment visualization includes three-dimensional renderings of the subsurface showing soil layers, the metallic target, and transmitter/receiver positions. Side-view cross-sections display the radial-vertical plane, clearly showing the layered earth structure and target position. Top-view projections illustrate the geometry from above, showing the circular transmitter loop and target cross-section.

The plotter uses an interactive menu system, allowing users to select which visualizations to display from the enabled options. This design provides flexibility while maintaining a clean user interface. Color schemes are automatically assigned based on data labels, with different gradient palettes for unconditioned, noise-free, and noisy datasets. The distance-dependent response is visualized using color intensity, where darker shades represent measurements taken close to the target and lighter shades represent measurements from greater distances.

## Installation Requirements

The simulation framework requires Python 3.8 or higher and depends on several scientific computing libraries:

- SimPEG: Core electromagnetic simulation engine
- discretize: Mesh generation and management
- NumPy: Numerical array operations
- Matplotlib: Visualization and plotting
- SciPy: Scientific computing utilities (implicit dependency)

Installation can be performed using pip:

```bash
pip install simpeg discretize numpy matplotlib scipy
```

For development work, consider installing in a virtual environment to maintain package isolation.

## Configuration Parameters

All simulation parameters are specified in the config.json file. The parameters are organized into logical groups:

### Transmitter Configuration

**tx_num**: Number of transmitter loops in the survey. Typically set to 1 for single-loop systems.

**tx_x, tx_y, tx_z**: Three-dimensional position of the transmitter loop center in meters. The z-coordinate represents height above ground, with z=0 at the surface.

**tx_current**: Current flowing through the transmitter loop in amperes. Higher currents produce stronger primary fields but may not be practical due to power and heating constraints. Typical values range from 1 to 100 amperes.

**tx_radius**: Radius of the circular transmitter loop in meters. Larger loops generate deeper-penetrating fields but have reduced sensitivity to shallow targets. Common values range from 0.2 to 1.0 meters.

**tx_n_turns**: Number of wire turns in the transmitter coil. Multiple turns increase the magnetic moment proportionally but also increase coil resistance and inductance.

### Receiver Configuration

**rx_num**: Number of receiver coils in the survey. Most configurations use a single receiver coincident with the transmitter.

**rx_x, rx_y, rx_z**: Three-dimensional position of the receiver coil center in meters. Often identical to transmitter position for coincident loop configuration.

**rx_radius**: Radius of the circular receiver loop in meters. Typically matches the transmitter radius in coincident configurations.

**rx_n_turns**: Number of wire turns in the receiver coil. More turns increase sensitivity but may affect frequency response and noise characteristics.

### Target Configuration

**target_x, target_y, target_z**: Three-dimensional position of the target center in meters. Negative z-values indicate burial depth below the surface.

**target_radius**: Outer radius of the cylindrical target in meters. For an aluminum can, this represents the can radius including the wall.

**target_height**: Vertical extent of the cylindrical target in meters. This is the dimension parallel to the z-axis.

**target_thickness**: Wall thickness for hollow cylindrical targets in meters. The inner radius is calculated as target_radius minus target_thickness. This parameter enables realistic modeling of cans, pipes, and shells. If thickness approaches or exceeds the mesh cell size, the algorithm automatically adjusts to ensure proper representation using the nearest radial cell layer.

### Conductivity Parameters

**air_conductivity**: Electrical conductivity of air in siemens per meter. Typically set to a very small value like 1e-8 S/m, representing essentially an insulator.

**soil_conductivity**: Electrical conductivity of soil in siemens per meter. Highly variable depending on moisture content, clay fraction, and dissolved salts. Dry sandy soil might be 0.01 S/m, while wet clay could exceed 1.0 S/m. The default value of 0.4 S/m represents moderately conductive soil.

**grass_conductivity**: Electrical conductivity of the grass or vegetation layer in siemens per meter. Usually lower than underlying soil due to organic content and root structure.

**aluminum_conductivity**: Electrical conductivity of the target material in siemens per meter. Aluminum has a conductivity around 3.5e7 S/m, making it highly detectable with electromagnetic methods. Other metals have different conductivities: copper is approximately 5.8e7 S/m, steel is around 1e6 S/m, and stainless steel may be as low as 1e6 S/m.

### Grass Layer Geometry

**grass_x_min, grass_x_max**: Horizontal extent of the grass layer in the x-direction in meters. Defines the region where grass conductivity is applied.

**grass_z_min, grass_z_max**: Vertical extent of the grass layer in meters. Typically a thin layer near the surface, often from z=0 to z=0.05 meters.

### Time Configuration

**time_channel_start**: Beginning of the observation time window in seconds. Often set to zero or a small positive value to avoid numerical issues at the instant of transmitter turn-off.

**time_channel_end**: End of the observation time window in seconds. Should be long enough to capture the complete decay of the electromagnetic response. For metal targets, this might range from 100 microseconds to several milliseconds.

**time_channel_step**: Time interval between measurement samples in seconds. Smaller steps provide better temporal resolution but increase computational cost and data volume.

**time_steps**: Time-stepping scheme for the electromagnetic solver. Specified as an array of [step_size, number_of_steps] pairs. The solver uses adaptive time-stepping to efficiently handle the rapid early-time changes and slower late-time evolution. For example, [[1e-6, 1024]] means take 1024 steps of 1 microsecond each.

### Mesh Configuration

**mesh_dh**: Base cell size for the computational mesh in meters. Smaller values provide better spatial resolution but dramatically increase computational requirements. The cell size should be small enough to resolve the target dimensions and electromagnetic skin depth.

**mesh_dom_width**: Total width of the computational domain in meters. Should be large enough that boundary conditions do not significantly affect the solution in the region of interest. Typically 2 to 5 times the maximum dimension of the transmitter-receiver-target geometry.

### Waveform Configuration

**waveform_type**: Type of transmitter waveform. Currently supports "step_off", which represents an instantaneous turn-off of constant transmitter current. This is the most common waveform for practical TDEM systems.

**waveform_off_time**: Time at which the transmitter current is turned off in seconds. Usually set to 0.0, with positive time representing the post-turn-off observation period.

**simulation_t0**: Start time for the simulation in seconds. Typically 0.0, representing the instant of transmitter turn-off.

## Usage Instructions

### Basic Simulation

To run a basic simulation with default parameters, ensure config.json is properly configured and execute the main script:

```bash
python pi_sim.py
```

The simulation will progress through several stages including configuration loading, mesh generation, model construction, electromagnetic forward modeling, and data processing. Progress information is printed to the console.

### Custom Configuration

To run simulations with different parameters, edit config.json to specify your desired configuration. Key parameters to consider adjusting include target depth (target_z), target geometry (radius, height, thickness), soil conductivity, and loop height (tx_z, rx_z). After modifying the configuration, run the simulation as normal.

### Processing Multiple Scenarios

The framework supports generating multiple processed versions of the same simulation data. For example, you can create unconditioned data, noise-free processed data with gain and quantization, and noisy data with realistic measurement noise. Each dataset is automatically labeled and color-coded for easy comparison.

### Interactive Visualization

After simulation completion, an interactive menu allows you to select which visualizations to display:

- Option 1: TDEM Linear - shows the electromagnetic decay on a linear time axis
- Option 2: TDEM Log-Log - displays the decay on logarithmic axes, emphasizing late-time behavior
- Option 3: 3D View - renders the three-dimensional geometry of the subsurface and instrumentation
- Option 4: Side View - presents a radial-vertical cross-section through the simulation domain
- Option 5: Top View - shows the geometry from above

Enter the number corresponding to your desired plot, or 'q' to quit. After closing each plot window, you will be prompted to select another view or exit.

## Simulation Workflow

A typical simulation proceeds through the following steps:

1. Configuration Loading: PiConfig reads parameters from config.json and initializes with default values where necessary.

2. Simulator Initialization: PiSimulator is instantiated with configuration object and survey parameters including loop starting height, height increment between measurements, and number of additional height increments.

3. Electromagnetic Simulation: The simulator creates the mesh, constructs conductivity models with and without the target, sets up TDEM surveys at multiple loop heights, and solves Maxwell's equations to compute electromagnetic responses.

4. Data Conditioning: PiConditioner applies signal processing to the raw simulation output. This may include time-dependent amplification, noise addition, normalization, and quantization to simulate realistic measurement data.

5. Visualization: PiPlotter generates interactive visualizations of the electromagnetic responses and subsurface geometry, allowing detailed examination of the simulation results.

6. Analysis: Users examine the plotted data to understand how target properties, burial depth, soil conditions, and measurement parameters affect detection performance.

## Physical Interpretation

Understanding the physical principles underlying the simulation helps in interpreting results and optimizing detection systems.

### Electromagnetic Induction Process

When the transmitter current is turned off, the collapsing primary magnetic field induces eddy currents in any nearby conductors according to Faraday's law of electromagnetic induction. These eddy currents are strongest immediately after turn-off and decay exponentially over time. The decay rate is governed by the electrical conductivity and magnetic permeability of the conductor, as well as its geometric properties.

In a hollow cylinder like an aluminum can, eddy currents flow circumferentially in the metallic wall. The time constant of the decay is related to the electromagnetic skin depth and the conductor dimensions. Larger, more conductive objects have longer time constants and produce more persistent signals.

### Early-Time vs Late-Time Response

The electromagnetic response can be divided into early-time and late-time regimes. Early-time response (typically microseconds after turn-off) is dominated by high-conductivity features like metallic targets. The signal is strong but decays rapidly. Late-time response (milliseconds after turn-off) contains information about lower-conductivity features like soil layers. The signal is much weaker but decays more slowly.

Detection systems must balance the need for early-time sensitivity to locate metal targets against late-time sensitivity to characterize the surrounding earth. This often requires time-dependent gain adjustments, which are simulated by the amplify method in PiConditioner.

### Distance Dependence

The electromagnetic coupling between transmitter, target, and receiver decreases rapidly with separation distance. The signal strength typically follows an inverse cube or higher power law with distance. This means that even small changes in loop height or burial depth can significantly affect detection performance. The simulation framework supports multiple loop heights to characterize this distance dependence, which is essential for understanding detection depth capabilities.

### Soil Effects

Conductive soil attenuates the electromagnetic field through Ohmic losses, reducing detection depth. However, the contrast between target and soil conductivity is what generates the measurable response. In highly conductive soil, even strongly conductive metal targets may produce only subtle responses. Conversely, in resistive soil, the target response is larger but the background noise may also be higher due to decreased electromagnetic shielding.

## Output Data Structure

The simulation generates structured data suitable for further analysis or machine learning applications.

### Time Arrays

Time arrays specify the observation times for each measurement. Returned as a list containing one numpy array with shape (N_time,) where N_time is the number of time channels. Time values are in seconds and are typically logarithmically spaced or follow the time-stepping scheme specified in the configuration.

### Decay Curves

Decay curves represent the measured electromagnetic response as a function of time. Returned as a list of numpy arrays, one for each survey configuration. The first array is always the "no target" response, representing the baseline electromagnetic field from soil and grass layers only. Subsequent arrays are "with target" responses for different loop heights. Each array has shape (N_time,) and contains values of -dBz/dt in tesla per second. The negative sign is applied to make the decay positive for typical induction responses.

### Plotting Information

Plotting information is a dictionary containing mesh objects, conductivity models, active cell indices, configuration parameters, and survey geometry details. This information enables comprehensive visualization without requiring access to the original simulation setup.

## Advanced Topics

### Mesh Refinement

The cylindrical mesh uses adaptive refinement to concentrate computational resources where accuracy is most critical. Refinement zones include the near-surface region where the transmitter and receiver are located, the target volume and surrounding space, and the interface between different conductivity layers. Users can adjust mesh resolution by modifying mesh_dh (base cell size) in the configuration. Smaller values provide better accuracy at the cost of increased memory usage and computation time.

### Hollow Cylinder Implementation

The hollow cylinder target representation requires careful handling of the radial discretization. The algorithm first computes the inner radius as outer_radius minus wall_thickness. It then determines the minimum radial cell width in the mesh. If the wall thickness is smaller than the cell width, the code selects only the outermost radial cell layer to represent the target. This ensures that even very thin-walled objects are properly represented in the discretized model. For thicker walls, all cells falling within the annular region between inner and outer radii are assigned the target conductivity.

### Time-Dependent Gain

Practical TDEM receivers often employ time-dependent gain to compress the wide dynamic range of the electromagnetic response. Early-time signals are strong and require little amplification, while late-time signals may be six or more orders of magnitude weaker and require substantial amplification. The amplify method implements piecewise-constant gain functions specified as [time, gain] pairs. For each time value, all subsequent measurements are multiplied by the corresponding gain factor. This approach mimics the behavior of switched-gain receivers commonly used in metal detectors.

### Noise Modeling

The add_noise method simulates measurement uncertainty by adding white Gaussian noise with power spectral density determined from the late-time signal. This approach assumes that signal-to-noise ratio is approximately constant in the late-time regime where the measurement is noise-dominated. The noise standard deviation is computed from the desired SNR and the measured signal power in the late-time window. This generates realistic noise patterns that scale appropriately with signal strength.

## Troubleshooting

### Common Issues

If the simulation runs very slowly, consider reducing the number of time steps, increasing mesh_dh to coarsen the mesh, or decreasing mesh_dom_width to reduce the domain size. Electromagnetic simulations are computationally intensive due to the need to solve large sparse linear systems at each time step.

If the target response appears identical to the no-target response, verify that target_z places the target within the active region of the conductivity model, ensure target_conductivity differs significantly from soil_conductivity, and confirm that target dimensions are large enough to be resolved by the mesh.

If visualizations appear blank or incorrect, check that update_times_data has been called before show_plots, verify that the label parameter matches one of the predefined color schemes, and ensure that decay arrays contain valid numerical values without NaN or Inf.

### Debugging Strategies

Enable verbose output by examining the configuration summary printed at simulation start. This displays all parameter values and can help identify configuration errors. Visualize the conductivity model using the side-view and 3D plots to confirm that soil layers and target geometry are correct. Compare with-target and no-target responses on the same plot to verify that the target produces a detectable signature. Experiment with parameter variations to understand sensitivity and identify optimal detection configurations.

## References and Further Reading

For users interested in deeper understanding of the underlying physics and numerical methods, consider the following resources:

- SimPEG documentation: https://simpeg.xyz - comprehensive guide to the simulation framework
- "Electromagnetics for Exploration Geophysics" by Kaufman and Keller - theoretical foundations of electromagnetic methods
- "Interpretation Theory in Applied Geophysics" by Grant and West - principles of geophysical data analysis
- TDEM method overview: Various papers on time-domain electromagnetic induction for landmine detection and unexploded ordnance characterization

## Project Context

This simulation framework was developed as part of the TFE4580 Specialization Project focusing on electromagnetic detection of buried metal objects. The code is structured to support both forward modeling for understanding detection physics and synthetic data generation for training machine learning algorithms. Future extensions may include support for arbitrary target geometries, incorporation of magnetic permeability effects for ferrous targets, multi-component receiver measurements, and automated parameter optimization for detection system design.
